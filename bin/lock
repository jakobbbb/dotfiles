#!/usr/bin/env sh

# Starts `xsecurelock` such that it shows the current wallpaper, blurred and
# darkened. The avarge color of the image is used as the box background.  Uses
# `saver_mpv` because it works out-of-the-box with multiple monitors with
# different resolutions.

wallpaper=$(tail -n 1 $HOME/.fehbg | sed -e "s/.*'\(.*\)'/\1/")

blurred_dir="$HOME/.cache/lock/wallpapers_blurred"
wallpaper_blurred="$blurred_dir/$(basename "$wallpaper")"
wallpaper_blurred=$(sed -e "s/\(.*\)\.[^\.]*/\1.png/g" <<< "$wallpaper_blurred")

if [ ! -f "$wallpaper_blurred" ]; then
    mkdir -p $(dirname "$wallpaper_blurred")
    magick \
        $wallpaper \
        -resize 100x100 \
        -alpha off \
        -evaluate Multiply 0.75 \
        -gaussian-blur 4 \
        $wallpaper_blurred
fi

avg_color=$(magick $wallpaper_blurred -resize 1x1 txt:- | grep -o "#[a-fA-F0-9]\{6\}")
avg_color_inv=$(magick $wallpaper_blurred -resize 1x1 -evaluate Multiply 0.4 -negate txt:- | grep -o "#[a-fA-F0-9]\{6\}")

env \
    XSECURELOCK_AUTH_BACKGROUND_COLOR="$avg_color" \
    XSECURELOCK_AUTH_FOREGROUND_COLOR="$avg_color_inv" \
    XSECURELOCK_DISCARD_FIRST_KEYPRESS=0 \
    XSECURELOCK_FONT="Meslo LG M for Powerline" \
    XSECURELOCK_IMAGE_DURATION_SECONDS="1000" \
    XSECURELOCK_LIST_VIDEOS_COMMAND="echo $wallpaper_blurred" \
    XSECURELOCK_PASSWORD_PROMPT=asterisks \
    XSECURELOCK_SAVER=saver_mpv \
    XSECURELOCK_SAVER_DELAY_MS="2" \
    XSECURELOCK_SHOW_DATETIME=1 \
    XSECURELOCK_VIDEOS_FLAGS="--panscan=1" \
    xsecurelock
